import { backendService } from './backendService';
import { openAIService } from './openaiService';
import type { PointOfInterest, User, ChatMessage } from '../types';

// Chave da API do Gemini - pode ser configurada via vari√°vel de ambiente
const API_KEY = (import.meta as any).env?.VITE_GEMINI_API_KEY || "AIzaSyCIO_I4T5g_bTXZDFvHcPvQwO6z2VyIitE";

// Fun√ß√£o auxiliar para chamar a API do Gemini com fallback para OpenAI
const callGeminiAPI = async (prompt: string, systemInstruction?: string) => {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
    
    let fullPrompt = prompt;
    if (systemInstruction) {
        fullPrompt = `${systemInstruction}\n\n${prompt}`;
    }
    
    const requestBody = {
        contents: [{
            parts: [{
                text: fullPrompt
            }]
        }],
        generationConfig: {
            temperature: 0.7,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 1024,
        }
    };

    console.log('Chamando API Gemini:', url);

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Gemini API Error:', errorText);
            throw new Error(`Gemini API error: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
            console.log('Resposta recebida do Gemini com sucesso');
            return data.candidates[0].content.parts[0].text;
        } else {
            console.error('Estrutura de resposta inesperada do Gemini:', data);
            throw new Error('Estrutura de resposta inesperada');
        }
    } catch (error) {
        console.warn('Gemini API falhou, tentando com OpenAI...', error);
        
        // Fallback para OpenAI
        try {
            const response = await openAIService.generateContent(prompt, systemInstruction);
            console.log('Resposta recebida do OpenAI com sucesso');
            return response;
        } catch (openAIError) {
            console.error('OpenAI tamb√©m falhou:', openAIError);
            throw new Error('Ambas APIs (Gemini e OpenAI) falharam');
        }
    }
};

export const askAIGuideStream = async (locationName: string, question: string) => {
  const prompt = `Voc√™ √© um guia tur√≠stico de Ca√ßapava do Sul. Um turista est√° visitando "${locationName}" e pergunta: "${question}". Responda de forma concisa, √∫til e calorosa.`;

  try {
    const response = await callGeminiAPI(prompt);
    
    // Simula um stream de resposta
    async function* responseStreamGenerator() {
        const words = response.split(' ');
        for (const word of words) {
            await new Promise(res => setTimeout(res, 50));
            yield { text: word + ' ' };
        }
    }
    return responseStreamGenerator();
  } catch (error) {
    console.error("Error calling Gemini API (askAIGuideStream):", error);
    
    // Fallback to a simulated stream on any API error.
    const simulatedResponse = `Desculpe, meu c√©rebro de IA est√° offline no momento. Mas tenho certeza que ${locationName} √© incr√≠vel! Tente perguntar a um guia local.`;
    
    async function* errorStreamGenerator() {
        for (const word of simulatedResponse.split(' ')) {
            await new Promise(res => setTimeout(res, 50));
            yield { text: word + ' ' };
        }
    }
    return errorStreamGenerator();
  }
};

interface ItineraryPreferences {
    duration: string;
    interests: string[];
    pace: string;
    notes: string;
}

export const generateItinerary = async (preferences: ItineraryPreferences): Promise<string> => {
    // Helper to categorize POIs for better matching
    const getPoiType = (poi: PointOfInterest): string => {
        const name = poi.name.toLowerCase();
        if (name.includes('pedra') || name.includes('guaritas') || name.includes('cascata')) return 'Natureza, Aventura';
        if (name.includes('forte') || name.includes('igreja') || name.includes('casa de ulh√¥a')) return 'Hist√≥ria, Cultura Local';
        if (name.includes('minas')) return 'Hist√≥ria, Aventura';
        if (name.includes('churrascaria') || name.includes('do√ßaria')) return 'Gastronomia';
        return 'Geral';
    }
    
    // Fetch POIs from the backend instead of using static constants
    const pointsOfInterest = await backendService.getPointsOfInterest();

    const poiList = pointsOfInterest.map(poi => 
        `- ${poi.name}: ${poi.description} (Tipo: ${getPoiType(poi)})`
    ).join('\n');

    const prompt = `Crie um roteiro de viagem para Ca√ßapava do Sul com base nas seguintes informa√ß√µes:

Pontos de Interesse Dispon√≠veis:
${poiList}

Prefer√™ncias do Turista:
- Dura√ß√£o: ${preferences.duration}
- Interesses: ${preferences.interests.join(', ')}
- Ritmo: ${preferences.pace}
- Observa√ß√µes: ${preferences.notes || 'Nenhuma'}

Instru√ß√µes:
1. Crie um roteiro organizado por dia e per√≠odo (manh√£, tarde, noite)
2. Use apenas os pontos de interesse listados acima
3. Seja amig√°vel e inspirador
4. Escreva de forma limpa, sem formata√ß√£o markdown
5. Comece com um t√≠tulo criativo

Gere um roteiro personalizado e detalhado.`;
    
    try {
        const response = await callGeminiAPI(prompt);
        return response;
    } catch (error) {
        console.error("Error calling Gemini API for itinerary:", error);
        // Fallback para resposta de demonstra√ß√£o mais inteligente
        return generateDemoItinerary(preferences);
    }
};

// Fun√ß√£o para gerar roteiro de demonstra√ß√£o baseado nas prefer√™ncias
function generateDemoItinerary(preferences: ItineraryPreferences): string {
    const { duration, interests, pace } = preferences;
    const days = parseInt(duration.split(' ')[0]) || 1;
    
    let roteiro = `üåü Roteiro Personalizado para Ca√ßapava do Sul\n`;
    roteiro += `Dura√ß√£o: ${duration} | Ritmo: ${pace} | Interesses: ${interests.join(', ')}\n\n`;
    
    for (let day = 1; day <= days; day++) {
        roteiro += `=== DIA ${day} ===\n\n`;
        
        // Manh√£
        roteiro += `MANH√É (9h-12h):\n`;
        if (interests.includes('natureza')) {
            roteiro += `- Pedra do Segredo: Trilha matinal com vista espetacular\n`;
            roteiro += `- Tempo: 2-3 horas | Dificuldade: Moderada\n`;
        } else if (interests.includes('historia')) {
            roteiro += `- Igreja Matriz: Arquitetura hist√≥rica no centro da cidade\n`;
            roteiro += `- Tempo: 1 hora | Dificuldade: F√°cil\n`;
        } else {
            roteiro += `- Centro Hist√≥rico: Caminhada pelo cora√ß√£o da cidade\n`;
            roteiro += `- Tempo: 2 horas | Dificuldade: F√°cil\n`;
        }
        
        // Tarde
        roteiro += `\nTARDE (14h-17h):\n`;
        if (interests.includes('natureza') && day === 1) {
            roteiro += `- Guaritas do Camaqu√£: Forma√ß√µes rochosas de 550 milh√µes de anos\n`;
            roteiro += `- Tempo: 3 horas | Dificuldade: Moderada\n`;
        } else if (interests.includes('gastronomia')) {
            roteiro += `- Tour pelos Azeites: Degusta√ß√£o de azeites premiados\n`;
            roteiro += `- Tempo: 2 horas | Dificuldade: F√°cil\n`;
        } else {
            roteiro += `- Minas do Camaqu√£: Hist√≥ria da minera√ß√£o local\n`;
            roteiro += `- Tempo: 2-3 horas | Dificuldade: Moderada\n`;
        }
        
        // Noite
        roteiro += `\nNOITE (19h):\n`;
        if (interests.includes('gastronomia')) {
            roteiro += `- Jantar em churrascaria tradicional ga√∫cha\n`;
            roteiro += `- Degusta√ß√£o de vinhos locais\n`;
        } else {
            roteiro += `- Jantar no centro com culin√°ria regional\n`;
            roteiro += `- Caminhada noturna pelas ruas hist√≥ricas\n`;
        }
        
        if (day < days) {
            roteiro += `\n`;
        }
    }
    
    roteiro += `\nüí° DICAS IMPORTANTES:\n`;
    roteiro += `- Leve protetor solar e √°gua para trilhas\n`;
    roteiro += `- Verifique hor√°rios de funcionamento\n`;
    roteiro += `- Use o GPS do app para navega√ß√£o\n`;
    
    roteiro += `\n‚ö†Ô∏è MODO DEMONSTRA√á√ÉO: Configure as APIs (Gemini/OpenAI) para roteiros mais precisos e atualizados.\n`;
    
    return roteiro;
}


export const getAIChatResponse = async (history: ChatMessage[], user: User): Promise<string> => {
    const pointsOfInterest = await backendService.getPointsOfInterest();
    const poiList = pointsOfInterest.map(poi => `- ${poi.name}: ${poi.description}`).join('\n');
    
    const visitedPoiObjects = await Promise.all(
        user.visited.map(visit => backendService.getPointOfInterestById(visit.pointId))
    );
    const visitedPoisText = visitedPoiObjects
        .filter(poi => poi !== null)
        .map(poi => poi!.name)
        .join(', ');

    const systemInstruction = `
        Voc√™ √© 'Cac√°', o assistente virtual amig√°vel e especialista do aplicativo "Visite Ca√ßapava do Sul".
        Sua personalidade √© calorosa, prestativa e um pouco divertida.
        Seu objetivo √© ajudar os turistas a aproveitarem ao m√°ximo a cidade e o aplicativo.

        **Seu Conhecimento:**
        1.  **Sobre a Cidade:** Voc√™ conhece todos os pontos tur√≠sticos listados abaixo. Use essa lista como sua √∫nica fonte de verdade para locais. N√£o invente lugares.
        2.  **Sobre o App:** Voc√™ entende o sistema de gamifica√ß√£o (pontos, badges, ranking). Check-in em um local d√° pontos. Completar rotas e visitar locais espec√≠ficos d√° badges (conquistas).
        3.  **Sobre o Usu√°rio:** Voc√™ est√° conversando com ${user.name}. Ele(a) tem ${user.points} pontos e j√° visitou os seguintes locais: ${visitedPoisText || 'Nenhum'}. Use essa informa√ß√£o para personalizar suas respostas.
        4.  **Navega√ß√£o:** Quando recomendar locais, SEMPRE mencione que o usu√°rio pode usar o bot√£o "Como Chegar" para navegar com Waze ou Google Maps.
        5.  **Funcionalidades do App:**
           - Se√ß√£o "Atra√ß√µes": Todos os pontos tur√≠sticos categorizados (natureza, hist√≥ria, gastronomia)
           - Se√ß√£o "Restaurantes": Locais para comer com sistema de avalia√ß√µes
           - Se√ß√£o "Azeites": Produtores locais premiados internacionalmente (mais de 300 pr√™mios!)
           - Sistema de Pontos: Ganha pontos visitando locais e fazendo check-in
           - Assistente Virtual (voc√™!): Sempre dispon√≠vel para ajudar

        **Lista de Pontos Tur√≠sticos Dispon√≠veis:**
        ${poiList}

        **Informa√ß√µes Especiais sobre Ca√ßapava do Sul:**
        - Famosa pelos azeites premiados (mais de 300 pr√™mios internacionais!)
        - Patrim√¥nio geol√≥gico √∫nico (Guaritas do Camaqu√£)
        - Rica tradi√ß√£o ga√∫cha e hist√≥ria militar
        - Produtores de azeite: Quinta do Vale, Olivas do Sul (ambos com tours dispon√≠veis)

        **Regras de Conversa:**
        - Seja conciso e direto.
        - Use emojis para deixar a conversa mais leve. üòâ
        - Sempre mencione navega√ß√£o quando recomendar locais
        - Se perguntarem sobre restaurantes, mencione o sistema de avalia√ß√µes
        - Se perguntarem sobre azeites, destaque os pr√™mios internacionais
        - Se n√£o souber a resposta, admita e sugira onde o usu√°rio pode encontrar a informa√ß√£o.
        - Sempre incentive o usu√°rio a explorar a cidade.
    `;
    
    try {
        // Para o chat, precisamos formatar o hist√≥rico corretamente
        const lastUserMessage = history.filter(msg => msg.role === 'user').pop();
        if (!lastUserMessage) {
            return "Ol√°! Como posso ajudar voc√™ hoje?";
        }
        
        const userPrompt = lastUserMessage.parts[0].text;
        console.log('Chat prompt:', userPrompt);
        
        const response = await callGeminiAPI(userPrompt, systemInstruction);
        return response;
    } catch (error) {
        console.error("Error calling Gemini API for chat:", error);
        // Fallback inteligente baseado na mensagem do usu√°rio
        return generateDemoChatResponse(history, user);
    }
};

// Fun√ß√£o para gerar resposta de chat de demonstra√ß√£o
function generateDemoChatResponse(history: ChatMessage[], user: User): string {
    const lastUserMessage = history.filter(msg => msg.role === 'user').pop();
    if (!lastUserMessage) {
        return "Ol√°! üëã Sou Cac√°, seu guia virtual de Ca√ßapava do Sul! Como posso ajudar?";
    }
    
    const userText = lastUserMessage.parts[0].text.toLowerCase();
    
    // Sauda√ß√µes
    if (userText.includes('ol√°') || userText.includes('oi') || userText.includes('bom dia')) {
        return `Ol√°, ${user.name}! üëã 

Que bom te ver aqui! Voc√™ j√° tem ${user.points} pontos no nosso sistema de gamifica√ß√£o. üéØ

Como posso ajudar voc√™ a explorar Ca√ßapava do Sul hoje?

‚ö†Ô∏è *Modo demonstra√ß√£o ativo - Configure as APIs para respostas mais precisas*`;
    }
    
    // Perguntas sobre pontos tur√≠sticos
    if (userText.includes('pedra') || userText.includes('segredo')) {
        return `üóø A Pedra do Segredo √© nosso cart√£o postal mais famoso!

√â uma forma√ß√£o rochosa √∫nica onde uma pedra gigante fica em equil√≠brio perfeito. A trilha leva cerca de 1 hora e a vista √© incr√≠vel! üì∏

üí° Use o bot√£o "Como Chegar" no app para navegar at√© l√° com GPS.

‚ö†Ô∏è *Modo demonstra√ß√£o - APIs n√£o configuradas*`;
    }
    
    if (userText.includes('guaritas') || userText.includes('camaqu√£')) {
        return `üèîÔ∏è As Guaritas do Camaqu√£ s√£o espetaculares!

Forma√ß√µes rochosas de 550 milh√µes de anos que parecem castelos medievais. √â considerado um dos geoparques mais importantes do Brasil! üáßüá∑

Perfeito para fotos e contempla√ß√£o da natureza.

‚ö†Ô∏è *Modo demonstra√ß√£o - Configure as APIs para informa√ß√µes mais detalhadas*`;
    }
    
    // Perguntas sobre azeites
    if (userText.includes('azeite') || userText.includes('oliva')) {
        return `ü´í Ca√ßapava √© famosa pelos azeites premiados!

Mais de 300 pr√™mios internacionais! üèÜ 

Os principais produtores s√£o:
- Quinta do Vale
- Olivas do Sul

Ambos oferecem tours e degusta√ß√£o!

‚ö†Ô∏è *Modo demonstra√ß√£o ativo*`;
    }
    
    // Perguntas sobre sistema de pontos
    if (userText.includes('ponto') || userText.includes('badge') || userText.includes('conquista')) {
        return `üéØ Sistema de Gamifica√ß√£o:

Voc√™ tem ${user.points} pontos! Continue explorando para ganhar mais:

- Check-in: 10-25 pontos
- Primeira visita: B√¥nus 2x
- Completar rotas: Badges especiais

${user.visited.length === 0 ? 'Fa√ßa seu primeiro check-in para come√ßar! üöÄ' : `Voc√™ j√° visitou ${user.visited.length} local(is)! üëè`}

‚ö†Ô∏è *Modo demonstra√ß√£o*`;
    }
    
    // Resposta gen√©rica
    return `Interessante pergunta sobre Ca√ßapava do Sul! ü§î

Sou seu guia virtual e posso ajudar com:
- üó∫Ô∏è Pontos tur√≠sticos
- üçΩÔ∏è Restaurantes 
- ü´í Azeites premiados
- üéØ Sistema de pontos
- üìç Navega√ß√£o

‚ö†Ô∏è **Modo Demonstra√ß√£o**: Configure as APIs do Gemini ou OpenAI para respostas mais precisas!

O que gostaria de saber?`;
}
